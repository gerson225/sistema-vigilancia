<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Monitoreo de C√°maras - SIVI</title>
  <link rel="stylesheet" href="/css/layout.css">
  <style>
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 8px;
    }

    .status-dot[style*="9b59b6"] {
      background-color: #9b59b6 !important;
      color: white;
    }
    
    
    h1 {
      color: white;
      margin-bottom: 20px;
      text-align: center;
    }
    
    /* Grid de c√°maras en mosaico */
    .cameras-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .camera-card {
      background: #2c3e50;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transition: transform 0.3s;
    }
    
    .camera-card:hover {
      transform: translateY(-5px);
    }
    
    .camera-header {
      padding: 15px;
      background: #34495e;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .camera-name {
      font-weight: bold;
      font-size: 16px;
    }
    
    .camera-status {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    
    .status-online { background-color: #2ecc71; }
    .status-offline { background-color: #e74c3c; }
    .status-recording { background-color: #3498db; }
    
    .camera-video {
      width: 100%;
      height: 250px;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      font-size: 14px;
      position: relative;
    }
    
    .video-placeholder {
      text-align: center;
    }
    
    .camera-actions {
      padding: 15px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.3s;
    }
    
    .btn-alert { background: #e74c3c; color: white; }
    .btn-toggle { background: #f39c12; color: white; }
    .btn-config { background: #3498db; color: white; }
    .btn-fullscreen { background: #27ae60; color: white; }
    
    .btn:hover {
      opacity: 0.9;
    }
    
    /* Modal de configuraci√≥n */
    .config-modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #2c3e50;
      padding: 20px;
      border-radius: 10px;
      z-index: 1000;
      min-width: 300px;
    }
    
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 999;
    }
    
    .config-option {
      margin: 10px 0;
    }
    
    .config-option label {
      display: block;
      margin-bottom: 5px;
      color: white;
    }
    
    .config-option input, .config-option select {
      width: 100%;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #34495e;
      background: #1a252f;
      color: white;
    }
    
    .stats-bar {
      display: flex;
      justify-content: space-around;
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .stat-item {
      text-align: center;
    }
    
    .stat-number {
      font-size: 24px;
      font-weight: bold;
      color: #3498db;
    }
    
    .stat-label {
      font-size: 12px;
      color: #bdc3c7;
    }
  </style>
  <script src="/js/session-manager.js"></script>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
      
    </div>

    <!-- Contenido principal -->
    <div class="main-content">
      <h1>üìπ Monitoreo de C√°maras en Tiempo Real</h1>
      
      <!-- Barra de estad√≠sticas -->
      <div class="stats-bar">
        <div class="stat-item">
          <div class="stat-number" id="totalCamaras">0</div>
          <div class="stat-label">Total C√°maras</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="camarasActivas">0</div>
          <div class="stat-label">C√°maras Activas</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="camarasOnline">0</div>
          <div class="stat-label">En L√≠nea</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="alertasHoy">0</div>
          <div class="stat-label">Alertas Hoy</div>
        </div>
      </div>
      
      <!-- Grid de c√°maras -->
      <div class="cameras-grid" id="camerasGrid">
        <!-- Las c√°maras se cargar√°n din√°micamente -->
      </div>
    </div>

    <!-- Modal de configuraci√≥n -->
    <div class="modal-overlay" id="configOverlay" onclick="cerrarConfig()"></div>
    <div class="config-modal" id="configModal">
      <h3>‚öôÔ∏è Configuraci√≥n de C√°mara</h3>
      <div class="config-option">
        <label>Nombre de la c√°mara:</label>
        <input type="text" id="configNombre" placeholder="Ej: Entrada Principal">
      </div>
      <div class="config-option">
        <label>Ubicaci√≥n:</label>
        <input type="text" id="configUbicacion" placeholder="Ej: Recepci√≥n">
      </div>
      <div class="config-option">
        <label>Direcci√≥n IP:</label>
        <input type="text" id="configIp" placeholder="192.168.1.100">
      </div>
      <div class="config-option">
        <label>Detecci√≥n autom√°tica:</label>
        <select id="configDeteccion">
          <option value="true">Activada</option>
          <option value="false">Desactivada</option>
        </select>
      </div>
      <div class="config-option">
        <label>Rotaci√≥n:</label>
        <select id="configRotacion">
          <option value="0">0¬∞</option>
          <option value="90">90¬∞</option>
          <option value="180">180¬∞</option>
          <option value="270">270¬∞</option>
        </select>
      </div>
      <div class="config-option">
        <label>Zoom:</label>
        <input type="range" id="configZoom" min="1" max="5" step="0.1" value="1">
        <span id="zoomValue">1x</span>
      </div>
      <div style="margin-top: 20px; display: flex; gap: 10px;">
        <button class="btn btn-success" onclick="guardarConfig()">üíæ Guardar</button>
        <button class="btn btn-alert" onclick="cerrarConfig()">‚ùå Cancelar</button>
      </div>
    </div>

    <!-- JavaScript -->
    <script>
      let estadoCamaras = {};
      let camaraConfigActual = null;
      
      // Cargar c√°maras al iniciar
      document.addEventListener('DOMContentLoaded', function() {
        cargarCamaras();
        
        // Actualizar valor del zoom
        document.getElementById('configZoom').addEventListener('input', function() {
          document.getElementById('zoomValue').textContent = this.value + 'x';
        });
      });
      
      // Funci√≥n para cargar c√°maras desde el backend
      async function cargarCamaras() {
        try {
          const response = await fetch('/api/camaras');
          if (response.ok) {
            const camaras = await response.json();
            camaras.forEach(camara => {
                estadoCamaras[camara.idCamara] = {
                    activa: camara.estado === 'ACTIVA',
                    online: camara.online || true
                };
            });
            actualizarGridCamaras(camaras);
            actualizarEstadisticas(camaras);
          } else {
            // Si no hay API, usar datos de prueba
            cargarCamarasPrueba();
          }
        } catch (error) {
          console.error('Error cargando c√°maras:', error);
          cargarCamarasPrueba();
        }
      }
      
      // Funci√≥n de respaldo con datos de prueba
      function cargarCamarasPrueba() {
        const camaras = [
          { 
            idCamara: 7, 
            nombreCamara: 'Camara Plaza Norte', 
            estado: 'ACTIVA', 
            ubicacion: 'Entrada principal', 
            direccionIp: '192.168.1.100',
            online: true,
            deteccionAutomatica: true
          },
          { 
            idCamara: 8,
            nombreCamara: 'Camara San Juan', 
            estado: 'INACTIVA', 
            ubicacion: 'Pasillo 1', 
            direccionIp: '192.168.1.101',
            online: false,
            deteccionAutomatica: false
          },
          { 
            idCamara: 9, 
            nombreCamara: 'Camara Miraflores', 
            estado: 'ACTIVA', 
            ubicacion: 'Estacionamiento', 
            direccionIp: '192.168.1.102',
            online: true,
            deteccionAutomatica: true
          },
          { 
            idCamara: 10, 
            nombreCamara: 'Camara Callao', 
            estado: 'ACTIVA', 
            ubicacion: 'Recepci√≥n', 
            direccionIp: '192.168.1.103',
            online: true,
            deteccionAutomatica: true
          },
          { 
            idCamara: 11, 
            nombreCamara: 'Camara Villa El Salvador', 
            estado: 'INACTIVA', 
            ubicacion: 'Sala de servidores', 
            direccionIp: '192.168.1.104',
            online: true,
            deteccionAutomatica: false
          },
          { 
            idCamara: 12, 
            nombreCamara: 'Camara Ate', 
            estado: 'ACTIVA', 
            ubicacion: 'Terraza', 
            direccionIp: '192.168.1.105',
            online: true,
            deteccionAutomatica: true
          }
        ];

      camaras.forEach(camara => {
        estadoCamaras[camara.idCamara] = {
            activa: camara.estado === 'ACTIVA',
            online: camara.online,
            deteccionAutomatica: camara.deteccionAutomatica
        };
    });
        
        actualizarGridCamaras(camaras);
        actualizarEstadisticas(camaras);
      }
      
      // Funci√≥n para actualizar el grid de c√°maras
      function actualizarGridCamaras(camaras) {
    const grid = document.getElementById('camerasGrid');
    grid.innerHTML = '';
    
    camaras.forEach(camara => {
        const estado = estadoCamaras[camara.idCamara];
        const isActive = estado.activa;
        const isOnline = estado.online;
        const tieneDeteccion = estado.deteccionAutomatica;
        
        const cameraCard = `
            <div class="camera-card" id="camera-${camara.idCamara}">
                <div class="camera-header">
                    <div class="camera-name">${camara.nombreCamara}</div>
                    <div class="camera-status">
                        <div class="status-dot ${isOnline ? 'status-online' : 'status-offline'}"></div>
                        <span>${isOnline ? 'En l√≠nea' : 'Desconectada'}</span>
                        ${isActive ? '<div class="status-dot status-recording" style="margin-left: 5px;" title="Grabando"></div>' : ''}
                        ${tieneDeteccion ? '<div class="status-dot" style="margin-left: 5px; background-color: #9b59b6;" title="Detecci√≥n autom√°tica activa">üîç</div>' : ''}
                    </div>
                </div>
                
                <div class="camera-video">
                    <div class="video-placeholder">
                        <div style="font-size: 48px;">üìπ</div>
                        <div>${camara.ubicacion}</div>
                        <div style="font-size: 12px; color: #95a5a6;">${camara.direccionIp}</div>
                        ${!isOnline ? '<div style="color: #e74c3c; margin-top: 5px;">‚õî C√°mara desconectada</div>' : ''}
                        ${!isActive ? '<div style="color: #f39c12; margin-top: 5px;">‚è∏Ô∏è C√°mara pausada</div>' : ''}
                        ${isActive && isOnline ? '<div style="color: #2ecc71; margin-top: 5px;">‚óè Grabando</div>' : ''}
                        ${tieneDeteccion ? '<div style="color: #9b59b6; margin-top: 5px;">üîç Detecci√≥n autom√°tica</div>' : '<div style="color: #e74c3c; margin-top: 5px;">üî¥ Detecci√≥n desactivada</div>'}
                    </div>
                </div>
                
                <div class="camera-actions">
                    <button class="btn btn-alert" onclick="generarAlertaCamara(${camara.idCamara})">üö® Alerta</button>
                    <button class="btn btn-toggle" onclick="toggleCamara(${camara.idCamara})">
                        ${isActive ? '‚è∏Ô∏è Pausar' : '‚ñ∂Ô∏è Activar'}
                    </button>
                    <button class="btn btn-config" onclick="abrirConfig(${camara.idCamara}, '${camara.nombreCamara}', '${camara.ubicacion}', '${camara.direccionIp}', estadoCamaras[${camara.idCamara}].deteccionAutomatica)">‚öôÔ∏è Config</button>
                    <button class="btn btn-fullscreen" onclick="pantallaCompleta(${camara.idCamara})">üì∫ Pantalla completa</button>
                </div>
            </div>
        `;
        grid.innerHTML += cameraCard;
        });
      }
      
      // üî• FUNCI√ìN PARA GENERAR SIDEBAR DIN√ÅMICO SEG√öN EL ROL


      // Funci√≥n para actualizar estad√≠sticas
      function actualizarEstadisticas(camaras) {
        const totalCamaras = camaras.length;
        const camarasActivas = camaras.filter(c => c.estado === 'ACTIVA').length;
        const camarasOnline = camaras.filter(c => c.online).length;
        
        document.getElementById('totalCamaras').textContent = totalCamaras;
        document.getElementById('camarasActivas').textContent = camarasActivas;
        document.getElementById('camarasOnline').textContent = camarasOnline;
        document.getElementById('alertasHoy').textContent = '0'; // Por ahora
      }
      
      // Funciones de acciones
      function generarAlertaCamara(idCamara) {
        const estado = estadoCamaras[idCamara];
        if (!estado.online) {
        alert('‚ùå No se puede generar alerta: C√°mara desconectada');
        return;
      }
        if (!estado.activa) {
        alert('‚ùå No se puede generar alerta: C√°mara pausada');
        return;
      }
    
    alert(`üö® Generando alerta para c√°mara ${idCamara}`);
    // Aqu√≠ integrar√≠as con tu sistema de alertas
      }
      
    async function toggleCamara(idCamara) {
    const estado = estadoCamaras[idCamara];
    
    if (!estado.online) {
        alert('‚ùå No se puede cambiar estado: C√°mara desconectada');
        return;
    }
    
    // Cambiar estado localmente
    estado.activa = !estado.activa;
    
    console.log('üîÑ Cambiando estado de c√°mara:', idCamara);
    console.log('üìä Nuevo estado:', estado);
    
    // üî• USAR LA FUNCI√ìN UNIFICADA PARA ACTUALIZAR LA VISTA
    actualizarCamaraIndividual(idCamara);
    
    alert(`‚úÖ C√°mara ${idCamara} ${estado.activa ? 'activada' : 'pausada'}`);
    
    // Aqu√≠ enviar√≠as el cambio al backend
    try {
        await fetch(`/api/camaras/${idCamara}/toggle`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
    } catch (error) {
        console.error('Error actualizando estado de c√°mara:', error);
    }
}
      
      function abrirConfig(idCamara, nombre, ubicacion, ip, deteccionActual) {
    camaraConfigActual = idCamara;
    document.getElementById('configNombre').value = nombre || '';
    document.getElementById('configUbicacion').value = ubicacion || '';
    document.getElementById('configIp').value = ip || '';
    
    console.log('üîß Abriendo configuraci√≥n c√°mara:', idCamara);
    console.log('üìä Detecci√≥n actual recibida:', deteccionActual);
    console.log('üìä Tipo de detecci√≥n recibida:', typeof deteccionActual);
    console.log('üìä Estado completo de la c√°mara:', estadoCamaras[idCamara]);
    
    // üî• OBTENER detecci√≥n autom√°tica del estadoCamaras si no viene como par√°metro
    let deteccionValue;
    if (deteccionActual !== undefined) {
        deteccionValue = deteccionActual;
    } else if (estadoCamaras[idCamara] && estadoCamaras[idCamara].deteccionAutomatica !== undefined) {
        deteccionValue = estadoCamaras[idCamara].deteccionAutomatica;
    } else {
        deteccionValue = true; // Valor por defecto
    }
    
    console.log('üìä Valor final de detecci√≥n:', deteccionValue);
    document.getElementById('configDeteccion').value = deteccionValue.toString();
    
    console.log('üìä Valor cargado en select:', document.getElementById('configDeteccion').value);
    
    document.getElementById('configOverlay').style.display = 'block';
    document.getElementById('configModal').style.display = 'block';
}
      
      function cerrarConfig() {
        document.getElementById('configOverlay').style.display = 'none';
        document.getElementById('configModal').style.display = 'none';
        camaraConfigActual = null;
      }
      
      function guardarConfig() {
        if (camaraConfigActual) {
          const nombre = document.getElementById('configNombre').value;
          const ubicacion = document.getElementById('configUbicacion').value;
          const ip = document.getElementById('configIp').value;

          const deteccionSelect = document.getElementById('configDeteccion');
          const deteccion = deteccionSelect.value === 'true';

          const rotacion = document.getElementById('configRotacion').value;
          const zoom = document.getElementById('configZoom').value;

          console.log('üíæ Guardando configuraci√≥n para c√°mara:', camaraConfigActual);
          console.log('üíæ Nueva detecci√≥n autom√°tica:', deteccion);
          
          if (estadoCamaras[camaraConfigActual]) {
            estadoCamaras[camaraConfigActual].deteccionAutomatica = deteccion;
            console.log('‚úÖ Estado actualizado:', estadoCamaras[camaraConfigActual]);
        } else {
            // üî• SI NO EXISTE, CREAR EL ESTADO
            estadoCamaras[camaraConfigActual] = {
                activa: true,
                online: true,
                deteccionAutomatica: deteccion
            };
            console.log('‚úÖ Estado creado:', estadoCamaras[camaraConfigActual]);
        }

          alert(`‚úÖ Configuraci√≥n guardada para c√°mara ${camaraConfigActual}\nNombre: ${nombre}\nUbicaci√≥n: ${ubicacion}\nIP: ${ip}\nDetecci√≥n: ${deteccion ? 'Activada' : 'Desactivada'}\nRotaci√≥n: ${rotacion}¬∞\nZoom: ${zoom}x`);
          
          actualizarCamaraIndividual(camaraConfigActual);
          cerrarConfig();
        }
      }

      function actualizarCamaraIndividual(idCamara) {
    console.log('üîÑ Actualizando c√°mara individual:', idCamara);
    console.log('üìä Estado actual:', estadoCamaras[idCamara]);
    
    const cameraCard = document.getElementById(`camera-${idCamara}`);
    if (!cameraCard) {
        console.log('‚ùå No se encontr√≥ la tarjeta de la c√°mara');
        return;
    }
    
    const estado = estadoCamaras[idCamara];
    const isActive = estado.activa;
    const isOnline = estado.online;
    const tieneDeteccion = estado.deteccionAutomatica;
    
    // üî• 1. ACTUALIZAR HEADER - Indicador de detecci√≥n
    const statusContainer = cameraCard.querySelector('.camera-status');
    let deteccionIndicator = statusContainer.querySelector('.status-dot[style*="9b59b6"]');
    
    if (tieneDeteccion) {
        if (!deteccionIndicator) {
            // Crear nuevo indicador de detecci√≥n
            deteccionIndicator = document.createElement('div');
            deteccionIndicator.className = 'status-dot';
            deteccionIndicator.style.marginLeft = '5px';
            deteccionIndicator.style.backgroundColor = '#9b59b6';
            deteccionIndicator.title = 'Detecci√≥n autom√°tica activa';
            deteccionIndicator.textContent = 'üîç';
            statusContainer.appendChild(deteccionIndicator);
        }
    } else {
        // Remover indicador si existe
        if (deteccionIndicator) {
            deteccionIndicator.remove();
        }
    }
    // üî• 2. ACTUALIZAR BOT√ìN TOGGLE
    const toggleButton = cameraCard.querySelector('.btn-toggle');
    if (toggleButton) {
        toggleButton.textContent = isActive ? '‚è∏Ô∏è Pausar' : '‚ñ∂Ô∏è Activar';
    }
    
    // üî• 3. ACTUALIZAR VIDEO PLACEHOLDER - Texto de detecci√≥n
    const videoPlaceholder = cameraCard.querySelector('.video-placeholder');
    if (videoPlaceholder) {
        // Remover textos de estado existentes
        const textosEstado = videoPlaceholder.querySelectorAll('div[style*="color:"]');
        textosEstado.forEach(texto => {
            if (texto.textContent.includes('Detecci√≥n') || 
                texto.textContent.includes('Grabando') || 
                texto.textContent.includes('C√°mara')) {
                texto.remove();
            }
        });
        // Agregar textos de estado actualizados
        if (!isOnline) {
            const offlineText = document.createElement('div');
            offlineText.style.color = '#e74c3c';
            offlineText.style.marginTop = '5px';
            offlineText.textContent = '‚õî C√°mara desconectada';
            videoPlaceholder.appendChild(offlineText);
        } else if (!isActive) {
            const pausedText = document.createElement('div');
            pausedText.style.color = '#f39c12';
            pausedText.style.marginTop = '5px';
            pausedText.textContent = '‚è∏Ô∏è C√°mara pausada';
            videoPlaceholder.appendChild(pausedText);
        } else {
            const recordingText = document.createElement('div');
            recordingText.style.color = '#2ecc71';
            recordingText.style.marginTop = '5px';
            recordingText.textContent = '‚óè Grabando';
            videoPlaceholder.appendChild(recordingText);
        }
   
        const deteccionText = document.createElement('div');
        deteccionText.style.marginTop = '5px';
        if (tieneDeteccion) {
            deteccionText.style.color = '#9b59b6';
            deteccionText.textContent = 'üîç Detecci√≥n autom√°tica';
        } else {
            deteccionText.style.color = '#e74c3c';
            deteccionText.textContent = 'üî¥ Detecci√≥n desactivada';
        }
        videoPlaceholder.appendChild(deteccionText);
    }
    
    const configButton = cameraCard.querySelector('.btn-config');
    if (configButton) {
        configButton.setAttribute('onclick', 
            `abrirConfig(${idCamara}, '${document.getElementById('configNombre').value}', '${document.getElementById('configUbicacion').value}', '${document.getElementById('configIp').value}', ${tieneDeteccion})`
        );
    }
    // üî• 5. ACTUALIZAR INDICADOR DE GRABACI√ìN
    const recordingIndicator = statusContainer.querySelector('.status-recording');
    if (isActive && isOnline) {
        if (!recordingIndicator) {
            const newRecordingIndicator = document.createElement('div');
            newRecordingIndicator.className = 'status-dot status-recording';
            newRecordingIndicator.style.marginLeft = '5px';
            newRecordingIndicator.title = 'Grabando';
            statusContainer.appendChild(newRecordingIndicator);
        }
    } else {
        if (recordingIndicator) {
            recordingIndicator.remove();
        }
    }
    
    console.log('‚úÖ Vista actualizada para c√°mara:', idCamara);
}  
    function pantallaCompleta(idCamara) {
    const estado = estadoCamaras[idCamara];
    if (!estado.online) {
        alert('‚ùå No se puede activar pantalla completa: C√°mara desconectada');
        return;
    }
    const cameraCard = document.getElementById(`camera-${idCamara}`);
    const videoSection = cameraCard.querySelector('.camera-video');
    if (videoSection.requestFullscreen) {
        videoSection.requestFullscreen();
    } else if (videoSection.webkitRequestFullscreen) {
        videoSection.webkitRequestFullscreen();
    } else if (videoSection.msRequestFullscreen) {
        videoSection.msRequestFullscreen();
    } else {
        alert(`üì∫ Simulando pantalla completa para c√°mara ${idCamara}\n\nEn una implementaci√≥n real, esto activar√≠a el modo pantalla completa del stream de video.`);
    }
    // Agregar estilo para pantalla completa
    videoSection.style.cursor = 'pointer';
    videoSection.onclick = function() {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        }
      };
      }
    </script>
</body>
</html>