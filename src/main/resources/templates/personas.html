<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gesti√≥n de Personas - SIVI</title>
    <link rel="stylesheet" href="/css/layout.css">
    <style>
        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
        }
        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-info {
            background: #9b59b6;
            color: white;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        th, td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }
        
        th {
            background-color: #2c3e50;
            color: white;
        }
        
        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        
        .badge-empleado { background: #27ae60; }
        .badge-visitante { background: #3498db; }
        .badge-sospechoso { background: #e74c3c; }
        .badge-desconocido { background: #95a5a6; }
        
        .persona-foto {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #ddd;
        }
        
        .filtros {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filtros input, .filtros select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        
        .stats-bar {
            display: flex;
            justify-content: space-around;
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }
        
        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 999;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 10px;
            z-index: 1000;
            min-width: 500px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-group textarea {
            height: 80px;
            resize: vertical;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
    </style>
    <script src="/js/session-manager.js"></script>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        
    </div>

    <!-- Contenido principal -->
    <div class="main-content">
        <div class="header-actions">
            <h1>üë• Gesti√≥n de Personas</h1>
            <button class="btn btn-success" onclick="abrirModalRegistro()">‚ûï Nueva Persona</button>
        </div>

        <!-- Barra de estad√≠sticas -->
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-number" id="totalPersonas">0</div>
                <div class="stat-label">Total Personas</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalEmpleados">0</div>
                <div class="stat-label">Empleados</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalVisitantes">0</div>
                <div class="stat-label">Visitantes</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalDesconocidos">0</div>
                <div class="stat-label">Desconocidos</div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filtros">
            <input type="text" id="filtroNombre" placeholder="üîç Buscar por nombre..." style="flex: 1;">
            <input type="text" id="filtroDni" placeholder="üî¢ Buscar por DNI...">
            <select id="filtroTipo">
                <option value="">Todos los tipos</option>
                <option value="EMPLEADO">Empleados</option>
                <option value="VISITANTE">Visitantes</option>
                <option value="SOSPECHOSO">Sospechosos</option>
                <option value="DESCONOCIDO">Desconocidos</option>
            </select>
            <button class="btn btn-primary" onclick="filtrarPersonas()">Filtrar</button>
            <button class="btn" onclick="limpiarFiltros()">Limpiar</button>
        </div>

        <!-- Tabla de personas -->
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Foto</th>
                    <th>Nombre</th>
                    <th>DNI</th>
                    <th>Tipo</th>
                    <th>Descripci√≥n</th>
                    <th>Fecha Registro</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tablaPersonas">
                <!-- Se llenar√° din√°micamente -->
            </tbody>
        </table>
    </div>

    <!-- Modal de Registro/Edici√≥n -->
    <div class="modal-overlay" id="modalOverlay" onclick="cerrarModal()"></div>
    <div class="modal" id="modalPersona">
        <h2 id="modalTitulo">Registrar Nueva Persona</h2>
        <form id="formPersona">
            <div class="form-group">
                <label for="modalNombre">Nombre completo *</label>
                <input type="text" id="modalNombre" required>
            </div>
            
            <div class="form-group">
                <label for="modalDni">DNI *</label>
                <input type="text" id="modalDni" required>
            </div>
            
            <div class="form-group">
                <label for="modalTipo">Tipo de persona *</label>
                <select id="modalTipo" required>
                    <option value="">Seleccionar tipo</option>
                    <option value="EMPLEADO">Empleado</option>
                    <option value="VISITANTE">Visitante</option>
                    <option value="SOSPECHOSO">Sospechoso</option>
                    <option value="DESCONOCIDO">Desconocido</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="modalDescripcion">Descripci√≥n/Observaciones</label>
                <textarea id="modalDescripcion" placeholder="Informaci√≥n adicional sobre la persona..."></textarea>
            </div>
            
            <div class="form-group">
                <label for="modalFoto">URL de la foto</label>
                <input type="text" id="modalFoto" placeholder="https://ejemplo.com/foto.jpg">
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-primary" onclick="guardarPersona()">üíæ Guardar</button>
                <button type="button" class="btn btn-danger" onclick="cerrarModal()">‚ùå Cancelar</button>
            </div>
        </form>
    </div>

    <!-- JavaScript -->
    <script>
        let personaEditando = null;
        
        // Cargar personas al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            cargarPersonas();
        });

        // Funci√≥n para cargar personas
        async function cargarPersonas() {
    
    
    try {
        // Por defecto, cargar todas las personas (filtros vac√≠os)
        const filtros = {
            nombre: '',
            dni: '',
            tipoPersona: ''
        };
        
        const response = await fetch('/api/personas/filtrar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(filtros)
        });
        
        if (response.ok) {
            const personas = await response.json();
            
            actualizarTablaPersonas(personas);
            actualizarEstadisticas(personas);
        } else {
            
            
            // Fallback al endpoint est√°ndar
            const responseStd = await fetch('/api/personas');
            if (responseStd.ok) {
                const personas = await responseStd.json();
                
                actualizarTablaPersonas(personas);
                actualizarEstadisticas(personas);
            } else {
                console.log('‚ùå Ambos endpoints fallaron, usando datos de prueba');
                cargarPersonasPrueba();
            }
        }
    } catch (error) {
        console.error('Error cargando personas:', error);
        cargarPersonasPrueba();
    }
}

        // Funci√≥n de respaldo con datos de prueba
        function cargarPersonasPrueba() {
            const personas = [
                {
                    idPersona: 1,
                    nombre: "Luis Perez",
                    dni: "12345678",
                    foto: "/images/persona1.png",
                    tipoPersona: "EMPLEADO",
                    descripcion: "Personal administrativo - √Årea de contabilidad",
                    fechaRegistro: "2024-01-15T10:00:00"
                },
                {
                    idPersona: 2,
                    nombre: "Carlos Ramirez", 
                    dni: "87654321",
                    foto: "/images/persona2.png",
                    tipoPersona: "VISITANTE",
                    descripcion: "Proveedor externo - Entrega de suministros",
                    fechaRegistro: "2024-02-20T14:30:00"
                },
                {
                    idPersona: 3,
                    nombre: "Persona No Identificada",
                    dni: "DESCONOCIDO",
                    foto: "/images/persona3.png",
                    tipoPersona: "DESCONOCIDO",
                    descripcion: "Rostro no reconocido en m√∫ltiples detecciones",
                    fechaRegistro: "2024-11-18T11:00:00"
                },
                {
                    idPersona: 4,
                    nombre: "Ana Gutierrez",
                    dni: "11223344",
                    foto: "/images/user-default.png",
                    tipoPersona: "EMPLEADO", 
                    descripcion: "Supervisora de seguridad",
                    fechaRegistro: "2024-03-10T09:15:00"
                }
            ];
            
            actualizarTablaPersonas(personas);
            actualizarEstadisticas(personas);
        }

        // Funci√≥n para actualizar la tabla
        function actualizarTablaPersonas(personas) {
            const tbody = document.getElementById('tablaPersonas');
            tbody.innerHTML = '';

            personas.forEach(persona => {
                const row = `
                    <tr>
                        <td>${persona.idPersona}</td>
                        <td>
                            <img src="${persona.foto || '/images/persona1.png'}"  
                                 alt="Foto" 
                                 class="persona-foto"
                                 onerror="this.src='/images/persona1.png'">
                        </td>
                        <td><strong>${persona.nombre}</strong></td>
                        <td>${persona.dni}</td>
                        <td>
                            <span class="badge badge-${persona.tipoPersona ? persona.tipoPersona.toLowerCase() : 'desconocido'}">
                                ${persona.tipoPersona || 'DESCONOCIDO'}
                            </span>
                        </td>
                        <td>${persona.descripcion || 'Sin descripci√≥n'}</td>
                        <td>${new Date(persona.fechaRegistro).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-info" onclick="verHistorial(${persona.idPersona})">üìä Historial</button>
                            <button class="btn btn-warning" onclick="editarPersona(${persona.idPersona})">‚úèÔ∏è Editar</button>
                            <button class="btn btn-danger" onclick="eliminarPersona(${persona.idPersona})">üóëÔ∏è Eliminar</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
        
function limpiarFiltros() {
    
    
    // Limpiar inputs de filtro
    document.getElementById('filtroNombre').value = '';
    document.getElementById('filtroDni').value = '';
    document.getElementById('filtroTipo').value = '';
    
    // Recargar todas las personas
    cargarPersonas();
}

// Permitir filtrar con Enter
document.addEventListener('DOMContentLoaded', function() {
    const inputsFiltro = ['filtroNombre', 'filtroDni'];
    
    inputsFiltro.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    filtrarPersonas();
                }
            });
        }
    });
    
    // Tambi√©n permitir Enter en el select
    const selectFiltro = document.getElementById('filtroTipo');
    if (selectFiltro) {
        selectFiltro.addEventListener('change', function() {
            filtrarPersonas();
        });
    }
    
    // Cargar personas al inicio
    cargarPersonas();
});

        // Funci√≥n para actualizar estad√≠sticas
        function actualizarEstadisticas(personas) {
            document.getElementById('totalPersonas').textContent = personas.length;
            document.getElementById('totalEmpleados').textContent = 
                personas.filter(p => p.tipoPersona === 'EMPLEADO').length;
            document.getElementById('totalVisitantes').textContent = 
                personas.filter(p => p.tipoPersona === 'VISITANTE').length;
            document.getElementById('totalDesconocidos').textContent = 
                personas.filter(p => p.tipoPersona === 'DESCONOCIDO').length;
        }

        // Funciones del modal
        function abrirModalRegistro() {
            personaEditando = null;
            document.getElementById('modalTitulo').textContent = '‚ûï Registrar Nueva Persona';
            document.getElementById('formPersona').reset();
            document.getElementById('modalOverlay').style.display = 'block';
            document.getElementById('modalPersona').style.display = 'block';
        }

        function cerrarModal() {
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('modalPersona').style.display = 'none';
            personaEditando = null;
        }

        async function editarPersona(idPersona) {
            try {
                const response = await fetch(`/api/personas/${idPersona}`);
                if (response.ok) {
                    const persona = await response.json();
                    personaEditando = persona;
                    
                    document.getElementById('modalTitulo').textContent = '‚úèÔ∏è Editar Persona';
                    document.getElementById('modalNombre').value = persona.nombre;
                    document.getElementById('modalDni').value = persona.dni;
                    document.getElementById('modalTipo').value = persona.tipoPersona || 'DESCONOCIDO';
                    document.getElementById('modalDescripcion').value = persona.descripcion || '';
                    document.getElementById('modalFoto').value = persona.foto || '';
                    
                    document.getElementById('modalOverlay').style.display = 'block';
                    document.getElementById('modalPersona').style.display = 'block';
                } else {
                    alert('Error al cargar los datos de la persona');
                }
            } catch (error) {
                console.error('Error editando persona:', error);
                alert('Error al cargar los datos de la persona');
            }
        }

        async function guardarPersona() {
            const formData = {
                nombre: document.getElementById('modalNombre').value,
                dni: document.getElementById('modalDni').value,
                tipoPersona: document.getElementById('modalTipo').value,
                descripcion: document.getElementById('modalDescripcion').value,
                foto: document.getElementById('modalFoto').value
            };

            if (!formData.nombre || !formData.dni || !formData.tipoPersona) {
                alert('Por favor complete todos los campos obligatorios (*)');
                return;
            }

            try {
                const url = personaEditando ? `/api/personas/${personaEditando.idPersona}` : '/api/personas';
                const method = personaEditando ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    alert(`‚úÖ Persona ${personaEditando ? 'actualizada' : 'registrada'} correctamente`);
                    cerrarModal();
                    cargarPersonas();
                } else {
                    alert('Error al guardar la persona');
                }
            } catch (error) {
                console.error('Error guardando persona:', error);
                alert('Error al guardar la persona');
            }
        }

        async function eliminarPersona(idPersona) {
            if (confirm('¬øEst√°s seguro de eliminar esta persona? Esta acci√≥n no se puede deshacer.')) {
                try {
                    const response = await fetch(`/api/personas/${idPersona}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        alert('‚úÖ Persona eliminada correctamente');
                        cargarPersonas();
                    } else {
                        alert('Error al eliminar la persona');
                    }
                } catch (error) {
                    console.error('Error eliminando persona:', error);
                    alert('Error al eliminar la persona');
                }
            }
        }
        function verHistorial(idPersona) {
            alert(`üìä Mostrando historial de detecciones para persona ${idPersona}\n\nEsta funci√≥n mostrar√≠a todas las detecciones asociadas a esta persona.`);
            // En una implementaci√≥n completa, esto navegar√≠a a una p√°gina de historial
            // o abrir√≠a un modal con la lista de detecciones
        }
        async function filtrarPersonas() {
    
    
    const nombre = document.getElementById('filtroNombre').value.trim();
    const dni = document.getElementById('filtroDni').value.trim();
    const tipoPersona = document.getElementById('filtroTipo').value;
    
    console.log('üìä Filtros - nombre:', nombre, 'dni:', dni, 'tipoPersona:', tipoPersona);
    
    try {
        // Mostrar carga
        const tbody = document.getElementById('tablaPersonas');
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">‚è≥ Filtrando personas...</td></tr>';
        
        // Preparar filtros
        const filtros = {};
        if (nombre) filtros.nombre = nombre;
        if (dni) filtros.dni = dni;
        if (tipoPersona) filtros.tipoPersona = tipoPersona;
        
        
        
        const response = await fetch('/api/personas/filtrar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(filtros)
        });
        
        if (!response.ok) {
            throw new Error('Error en la respuesta: ' + response.status);
        }
        
        const personas = await response.json();
        console.log('‚úÖ Personas recibidas:', personas.length);
        
        // Mostrar resultados
        if (personas.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: #7f8c8d;">üì≠ No se encontraron personas con los filtros aplicados</td></tr>';
        } else {
            actualizarTablaPersonas(personas);
        }
        
        actualizarEstadisticas(personas);
        
    } catch (error) {
        console.error('‚ùå Error en filtrado:', error);
        
        // Fallback: intentar con endpoint de prueba
        try {
            
            
            let url = '/api/personas/test-filtrar?';
            if (nombre) url += `nombre=${encodeURIComponent(nombre)}&`;
            if (dni) url += `dni=${encodeURIComponent(dni)}&`;
            if (tipoPersona) url += `tipoPersona=${encodeURIComponent(tipoPersona)}&`;
            
            const response = await fetch(url);
            if (response.ok) {
                const personas = await response.json();
                
                actualizarTablaPersonas(personas);
                actualizarEstadisticas(personas);
                return;
            }
        } catch (error2) {
            console.error('‚ùå Tambi√©n fall√≥ endpoint de prueba:', error2);
        }
        
        // √öltimo fallback: filtrar en el cliente
        console.log('üîÑ Filtrando en cliente...');
        const response = await fetch('/api/personas');
        if (response.ok) {
            const todasPersonas = await response.json();
            
            const personasFiltradas = todasPersonas.filter(persona => {
                let cumple = true;
                
                if (nombre) {
                    cumple = cumple && persona.nombre.toLowerCase().includes(nombre.toLowerCase());
                }
                
                if (dni) {
                    cumple = cumple && persona.dni.includes(dni);
                }
                
                if (tipoPersona) {
                    cumple = cumple && persona.tipoPersona === tipoPersona;
                }
                
                return cumple;
            });
            
            console.log('‚úÖ Personas filtradas en cliente:', personasFiltradas.length);
            actualizarTablaPersonas(personasFiltradas);
            actualizarEstadisticas(personasFiltradas);
        }
    }
}
    </script>
</body>
</html>