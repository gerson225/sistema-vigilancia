<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Alertas - SIVI</title>
  <link rel="stylesheet" href="/css/layout.css">
  <style>
    
    
    h1 {
      color: #2c3e50;
      margin-bottom: 20px;
    }
    
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .card {
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      background: white;
      text-align: center;
    }
    
    .card h5 {
      margin-bottom: 10px;
      color: #2c3e50;
    }
    
    .card p {
      font-size: 1.5rem;
      font-weight: bold;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    
    th, td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      text-align: center;
    }
    
    th {
      background-color: #2c3e50;
      color: white;
    }
    
    .badge {
      padding: 5px 10px;
      border-radius: 15px;
      color: white;
      font-size: 12px;
      font-weight: bold;
    }
    
    .criticidad-baja { background-color: #27ae60; }
    .criticidad-media { background-color: #f39c12; }
    .criticidad-alta { background-color: #e74c3c; }
    .criticidad-critica { background-color: #8b0000; }
    
    .estado-pendiente { background-color: #f39c12; }
    .estado-proceso { background-color: #3498db; }
    .estado-resuelta { background-color: #27ae60; }
    .estado-descartada { background-color: #95a5a6; }
    
    .btn {
      padding: 6px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      margin: 2px;
    }
    
    .btn-primary { background-color: #3498db; color: white; }
    .btn-success { background-color: #27ae60; color: white; }
    .btn-warning { background-color: #f39c12; color: white; }
    .btn-danger { background-color: #e74c3c; color: white; }
    
    .filtros {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .filtros select, .filtros button {
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
  </style>
  <script src="/js/session-manager.js"></script>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
      
    </div>

    <!-- Contenido principal -->
    <div class="main-content">
      <h1>üö® Panel de Alertas</h1>

      <!-- Filtros -->
      <div class="filtros">
        <select id="filtroEstado">
          <option value="">Todos los estados</option>
          <option value="PENDIENTE">Pendientes</option>
          <option value="EN_PROCESO">En proceso</option>
          <option value="RESUELTA">Resueltas</option>
          <option value="DESCARTADA">Descartadas</option>
        </select>
        
        <select id="filtroCriticidad">
          <option value="">Todas las criticidades</option>
          <option value="BAJA">Baja</option>
          <option value="MEDIA">Media</option>
          <option value="ALTA">Alta</option>
          <option value="CRITICA">Cr√≠tica</option>
        </select>
        
        <button onclick="filtrarAlertas()">Filtrar</button>
        <button onclick="limpiarFiltros()">Limpiar</button>
      </div>

      <!-- Cards de m√©tricas -->
      <div class="dashboard-grid">
        <div class="card">
          <h5>Total de Alertas</h5>
          <p id="totalAlertas">0</p>
        </div>
        <div class="card">
          <h5>Cr√≠ticas</h5>
          <p style="color: #8b0000;" id="alertasCriticas">0</p>
        </div>
        <div class="card">
          <h5>Pendientes</h5>
          <p style="color: #f39c12;" id="alertasPendientes">0</p>
        </div>
        <div class="card">
          <h5>Resueltas</h5>
          <p style="color: #27ae60;" id="alertasResueltas">0</p>
        </div>
      </div>

      <!-- Tabla de alertas -->
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Fecha/Hora</th>
            <th>Tipo</th>
            <th>Nivel Criticidad</th>
            <th>Estado</th>
            <th>Responsable</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaAlertas">
          <!-- Se llenar√° din√°micamente -->
        </tbody>
      </table>
    </div>

    <!-- JavaScript -->
    <script>
      // Cargar alertas al iniciar
      document.addEventListener('DOMContentLoaded', function() {
        cargarAlertas();
      });

      // Funci√≥n para cargar alertas
      async function cargarAlertas() {
        try {
          const response = await fetch('/api/alertas');
          const alertas = await response.json();
          actualizarTabla(alertas);
          actualizarMetricas(alertas);
        } catch (error) {
          console.error('Error cargando alertas:', error);
        }
      }

      // Funci√≥n para actualizar la tabla
      function actualizarTabla(alertas) {
        const tbody = document.getElementById('tablaAlertas');
        tbody.innerHTML = '';

        alertas.forEach(alerta => {
          const row = `
            <tr>
              <td>${alerta.idAlerta}</td>
              <td>${new Date(alerta.fechaAlerta).toLocaleString()}</td>
              <td>${alerta.tipoAlerta}</td>
              <td>
                <span class="badge criticidad-${alerta.nivelCriticidad ? alerta.nivelCriticidad.toLowerCase() : 'media'}">
                  ${alerta.nivelCriticidad || 'MEDIA'}
                </span>
              </td>
              <td>
                <span class="badge estado-${alerta.estadoAlerta ? alerta.estadoAlerta.toLowerCase() : 'pendiente'}">
                  ${alerta.estadoAlerta || 'PENDIENTE'}
                </span>
              </td>
              <td>${alerta.usuarioResponsable ? alerta.usuarioResponsable.nombre : 'Sin asignar'}</td>
              <td>
                <button class="btn btn-primary" onclick="verDetalleAlerta(${alerta.idAlerta})">üëÅÔ∏è Ver</button>
                <button class="btn btn-warning" onclick="asignarmeAlerta(${alerta.idAlerta})">üë§ Asignarme</button>
                <button class="btn btn-success" onclick="resolverAlerta(${alerta.idAlerta})">‚úÖ Resolver</button>
              </td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      }
     

      // Funci√≥n para actualizar m√©tricas
      function actualizarMetricas(alertas) {
        document.getElementById('totalAlertas').textContent = alertas.length;
        document.getElementById('alertasCriticas').textContent = 
          alertas.filter(a => a.nivelCriticidad === 'CRITICA').length;
        document.getElementById('alertasPendientes').textContent = 
          alertas.filter(a => a.estadoAlerta === 'PENDIENTE').length;
        document.getElementById('alertasResueltas').textContent = 
          alertas.filter(a => a.estadoAlerta === 'RESUELTA').length;
      }

      // Funciones de filtrado - ACTUALIZAR
async function filtrarAlertas() {
    const estado = document.getElementById('filtroEstado').value;
    const nivelCriticidad = document.getElementById('filtroCriticidad').value;
    
    const filtros = {
        estado: estado,
        nivelCriticidad: nivelCriticidad
    };

    try {
        const response = await fetch('/api/alertas/filtrar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(filtros)
        });
        
        if (response.ok) {
            const alertasFiltradas = await response.json();
            actualizarTabla(alertasFiltradas);
            actualizarMetricas(alertasFiltradas);
        } else {
            // Si falla el filtrado, cargar todas
            cargarAlertas();
        }
    } catch (error) {
        console.error('Error filtrando alertas:', error);
        cargarAlertas();
    }
}

function limpiarFiltros() {
    document.getElementById('filtroEstado').value = '';
    document.getElementById('filtroCriticidad').value = '';
    cargarAlertas();
}

      function limpiarFiltros() {
        document.getElementById('filtroEstado').value = '';
        document.getElementById('filtroCriticidad').value = '';
        cargarAlertas();
      }

      // Funciones de acciones
      async function verDetalleAlerta(idAlerta) {
    try {
        const response = await fetch(`/api/alertas/${idAlerta}`);
        const alerta = await response.json();
        
        let detalle = `
üö® DETALLE DE ALERTA #${alerta.idAlerta}

üìÖ Fecha: ${new Date(alerta.fechaAlerta).toLocaleString()}
üìã Tipo: ${alerta.tipoAlerta}
‚ö†Ô∏è  Nivel: ${alerta.nivelCriticidad}
üìä Estado: ${alerta.estadoAlerta}
üìù Descripci√≥n: ${alerta.descripcion}
üë§ Responsable: ${alerta.usuarioResponsable ? alerta.usuarioResponsable.nombre : 'Sin asignar'}
‚úÖ Acciones: ${alerta.accionesTomadas || 'No especificadas'}
`;

        if (alerta.deteccion) {
            detalle += `
üîç INFORMACI√ìN DE DETECCI√ìN:
   - Persona: ${alerta.deteccion.persona ? alerta.deteccion.persona.nombre : 'Desconocido'}
   - Tipo: ${alerta.deteccion.tipoDeteccion}
   - C√°mara: ${alerta.deteccion.camara ? alerta.deteccion.camara.nombreCamara : 'No especificada'}
   - Resultado: ${alerta.deteccion.resultado || 'N/A'}
`;
        }

        alert(detalle);
    } catch (error) {
        console.error('Error cargando detalle:', error);
        alert('Error al cargar los detalles de la alerta');
    }
}

      async function asignarmeAlerta(idAlerta) {
        try {
          const response = await fetch(`/api/alertas/${idAlerta}/asignar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          
          if (response.ok) {
            alert('Alerta asignada correctamente');
            cargarAlertas();
          }
        } catch (error) {
          console.error('Error asignando alerta:', error);
        }
      }

      async function resolverAlerta(idAlerta) {
        const acciones = prompt('Describe las acciones tomadas:');
        if (acciones) {
          try {
            const response = await fetch(`/api/alertas/${idAlerta}/resolver`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ accionesTomadas: acciones })
            });
            
            if (response.ok) {
              alert('Alerta resuelta correctamente');
              cargarAlertas();
            }
          } catch (error) {
            console.error('Error resolviendo alerta:', error);
          }
        }
      }
    </script>
</body>
</html>