<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Alertas - SIVI</title>
  <link rel="stylesheet" href="/css/layout.css">
  <style>
    /* Estilos base */
    h1 {
      color: #2c3e50;
      margin-bottom: 20px;
    }
    
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .card {
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      background: white;
      text-align: center;
    }
    
    .card h5 {
      margin-bottom: 10px;
      color: #2c3e50;
    }
    
    .card p {
      font-size: 1.5rem;
      font-weight: bold;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    
    th, td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      text-align: center;
    }
    
    th {
      background-color: #2c3e50;
      color: white;
    }
    
    .badge {
      padding: 5px 10px;
      border-radius: 15px;
      color: white;
      font-size: 12px;
      font-weight: bold;
    }
    
    .criticidad-baja { background-color: #27ae60; }
    .criticidad-media { background-color: #f39c12; }
    .criticidad-alta { background-color: #e74c3c; }
    .criticidad-critica { background-color: #8b0000; }
    
    .estado-pendiente { background-color: #f39c12; }
    .estado-proceso { background-color: #3498db; }
    .estado-resuelta { background-color: #27ae60; }
    .estado-descartada { background-color: #95a5a6; }
    
    .btn {
      padding: 6px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      margin: 2px;
    }
    
    .btn-primary { background-color: #3498db; color: white; }
    .btn-success { background-color: #27ae60; color: white; }
    .btn-warning { background-color: #f39c12; color: white; }
    .btn-danger { background-color: #e74c3c; color: white; }
    .btn-info { background-color: #17a2b8; color: white; }
    .btn-secondary { background-color: #6c757d; color: white; }
    .btn-dark { background-color: #343a40; color: white; }
    
    /* Nuevos estilos para botones espec√≠ficos */
    .btn-escalar { background-color: #8b0000; color: white; }
    .btn-reasignar { background-color: #9b59b6; color: white; }
    .btn-falsa { background-color: #95a5a6; color: white; }
    .btn-historial { background-color: #34495e; color: white; }
    .btn-exportar { background-color: #16a085; color: white; }
    .btn-escalar-operador { background-color: #d35400; color: white; }
    
    .filtros {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .filtros select, .filtros button {
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    
    /* Modal para formularios */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 20px;
      border-radius: 8px;
      width: 400px;
      max-width: 90%;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .close {
      font-size: 24px;
      cursor: pointer;
      color: #aaa;
    }
    
    .close:hover {
      color: #000;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #2c3e50;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    
    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .btn-group button {
      flex: 1;
    }
    
    /* Estilos para botones en tabla */
    .acciones-container {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      justify-content: center;
    }
  </style>
  <script src="/js/session-manager.js"></script>
</head>
<body>
    <!-- Sidebar se generar√° autom√°ticamente -->

    <!-- Contenido principal -->
    <div class="main-content">
      <h1>üö® Panel de Alertas</h1>

      <!-- Filtros -->
      <div class="filtros">
        <select id="filtroEstado">
          <option value="">Todos los estados</option>
          <option value="PENDIENTE">Pendientes</option>
          <option value="EN_PROCESO">En proceso</option>
          <option value="RESUELTA">Resueltas</option>
          <option value="DESCARTADA">Descartadas</option>
        </select>
        
        <select id="filtroCriticidad">
          <option value="">Todas las criticidades</option>
          <option value="BAJA">Baja</option>
          <option value="MEDIA">Media</option>
          <option value="ALTA">Alta</option>
          <option value="CRITICA">Cr√≠tica</option>
        </select>
        
        <button onclick="filtrarAlertas()" class="btn btn-primary">Filtrar</button>
        <button onclick="limpiarFiltros()" class="btn btn-secondary">Limpiar</button>
      </div>

      <!-- Cards de m√©tricas -->
      <div class="dashboard-grid">
        <div class="card">
          <h5>Total de Alertas</h5>
          <p id="totalAlertas">0</p>
        </div>
        <div class="card">
          <h5>Cr√≠ticas</h5>
          <p style="color: #8b0000;" id="alertasCriticas">0</p>
        </div>
        <div class="card">
          <h5>Pendientes</h5>
          <p style="color: #f39c12;" id="alertasPendientes">0</p>
        </div>
        <div class="card">
          <h5>Resueltas</h5>
          <p style="color: #27ae60;" id="alertasResueltas">0</p>
        </div>
      </div>

      <!-- Tabla de alertas -->
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Fecha/Hora</th>
            <th>Tipo</th>
            <th>Nivel Criticidad</th>
            <th>Estado</th>
            <th>Responsable</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaAlertas">
          <!-- Se llenar√° din√°micamente -->
        </tbody>
      </table>
    </div>

    <!-- Modal para Resolver con Observaci√≥n -->
    <div id="modalResolver" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>‚úÖ Resolver Alerta</h3>
          <span class="close" onclick="cerrarModalCentrado('modalResolver')">&times;</span>
        </div>
        <div class="modal-body">
          <form id="formResolver">
            <input type="hidden" id="alertaResolverId">
            <div class="form-group">
              <label for="accionesTomadas">Acciones Tomadas:</label>
              <textarea id="accionesTomadas" rows="3" placeholder="Describe las acciones realizadas..." required></textarea>
            </div>
            <div class="form-group">
              <label for="observacionesResolucion">Observaciones (Obligatorias):</label>
              <textarea id="observacionesResolucion" rows="3" placeholder="Detalle lo que se hizo para resolver..." required></textarea>
            </div>
            <div class="btn-group">
              <button type="button" onclick="confirmarResolucion()" class="btn btn-success">‚úÖ Resolver</button>
              <button type="button" onclick="cerrarModalCentrado('modalResolver')" class="btn btn-secondary">Cancelar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal para Falsa Alarma -->
    <div id="modalFalsaAlarma" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>üö´ Marcar como Falsa Alarma</h3>
          <span class="close" onclick="cerrarModalCentrado('modalFalsaAlarma')">&times;</span>
        </div>
        <div class="modal-body">
          <form id="formFalsaAlarma">
            <input type="hidden" id="alertaFalsaId">
            <div class="form-group">
              <label for="motivoFalsa">Motivo:</label>
              <textarea id="motivoFalsa" rows="4" placeholder="Ej: Movimiento normal, error del sistema, prueba..." required></textarea>
            </div>
            <div class="btn-group">
              <button type="button" onclick="confirmarFalsaAlarma()" class="btn btn-danger">üö´ Marcar como Falsa</button>
              <button type="button" onclick="cerrarModalCentrado('modalFalsaAlarma')" class="btn btn-secondary">Cancelar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal para Escalar -->
    <div id="modalEscalar" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>‚ö° Escalar Alerta a Cr√≠tica</h3>
          <span class="close" onclick="cerrarModalCentrado('modalEscalar')">&times;</span>
        </div>
        <div class="modal-body">
          <form id="formEscalar">
            <input type="hidden" id="alertaEscalarId">
            <div class="form-group">
              <label for="motivoEscalar">Motivo para escalar:</label>
              <textarea id="motivoEscalar" rows="4" placeholder="¬øPor qu√© necesita escalar esta alerta a cr√≠tica?" required></textarea>
            </div>
            <div class="btn-group">
              <button type="button" onclick="confirmarEscalacion()" class="btn btn-escalar">‚ö° Escalar a Cr√≠tica</button>
              <button type="button" onclick="cerrarModalCentrado('modalEscalar')" class="btn btn-secondary">Cancelar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal para Reasignar -->
    <div id="modalReasignar" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>üîÑ Reasignar Alerta</h3>
          <span class="close" onclick="cerrarModalCentrado('modalReasignar')">&times;</span>
        </div>
        <div class="modal-body">
          <form id="formReasignar">
            <input type="hidden" id="alertaReasignarId">
            <div class="form-group">
              <label for="nuevoResponsable">Nuevo Responsable:</label>
              <select id="nuevoResponsable" required>
                <option value="">Cargando usuarios...</option>
              </select>
            </div>
            <div class="form-group">
              <label for="motivoReasignar">Motivo:</label>
              <textarea id="motivoReasignar" rows="3" placeholder="¬øPor qu√© necesita reasignar esta alerta?" required></textarea>
            </div>
            <div class="btn-group">
              <button type="button" onclick="confirmarReasignacion()" class="btn btn-reasignar">üîÑ Reasignar</button>
              <button type="button" onclick="cerrarModalCentrado('modalReasignar')" class="btn btn-secondary">Cancelar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal para Escalar a Admin -->
    <div id="modalEscalarAdmin" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>üÜò Escalar al Administrador</h3>
          <span class="close" onclick="cerrarModalCentrado('modalEscalarAdmin')">&times;</span>
        </div>
        <div class="modal-body">
          <form id="formEscalarAdmin">
            <input type="hidden" id="alertaEscalarAdminId">
            <div class="form-group">
              <label for="motivoEscalarAdmin">Motivo:</label>
              <textarea id="motivoEscalarAdmin" rows="4" placeholder="¬øPor qu√© necesita escalar esta alerta al administrador?" required></textarea>
            </div>
            <div class="btn-group">
              <button type="button" onclick="confirmarEscalacionAdmin()" class="btn btn-escalar-operador">üÜò Escalar a Admin</button>
              <button type="button" onclick="cerrarModalCentrado('modalEscalarAdmin')" class="btn btn-secondary">Cancelar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal para Historial -->
    <div id="modalHistorial" class="modal">
      <div class="modal-content" style="width: 600px; max-height: 80vh;">
        <div class="modal-header">
          <h3>üìã Historial de Alerta #<span id="historialAlertaId"></span></h3>
          <span class="close" onclick="cerrarModalCentrado('modalHistorial')">&times;</span>
        </div>
        <div class="modal-body">
          <pre id="contenidoHistorial" style="background: #f5f5f5; padding: 15px; border-radius: 5px; max-height: 60vh; overflow-y: auto; white-space: pre-wrap; font-family: monospace;"></pre>
        </div>
      </div>
    </div>

    <!-- JavaScript -->
    <script>

      if (typeof abrirModalCentrado !== 'function') {
    function abrirModalCentrado(modalId) {
        const modal = document.getElementById(modalId);
        const overlay = document.getElementById('modalOverlay');
        
        if (!modal || !overlay) return;
        
        modal.style.cssText = `
            display: block;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        `;
        
        overlay.style.cssText = `
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 999;
        `;
        
        document.body.style.overflow = 'hidden';
    }
}

if (typeof cerrarModalCentrado !== 'function') {
    function cerrarModalCentrado(modalId) {
        const modal = document.getElementById(modalId);
        const overlay = document.getElementById('modalOverlay');
        
        if (modal) modal.style.display = 'none';
        if (overlay) overlay.style.display = 'none';
        
        document.body.style.overflow = 'auto';
        
        const form = document.querySelector(`#${modalId} form`);
        if (form) form.reset();
    }
}

// Funci√≥n para cerrar desde overlay
function cerrarModalDesdeOverlay() {
    document.querySelectorAll('.modal').forEach(modal => {
        modal.style.display = 'none';
    });
    
    const overlay = document.getElementById('modalOverlay');
    if (overlay) overlay.style.display = 'none';
    
    document.body.style.overflow = 'auto';
}

      // Variables globales
      let alertasActuales = [];

      // Cargar alertas al iniciar
      document.addEventListener('DOMContentLoaded', function() {
        cargarAlertas();
      });

      // Funci√≥n para cargar alertas
      async function cargarAlertas() {
        try {
          const response = await fetch('/api/alertas');
          if (!response.ok) throw new Error('Error al cargar alertas');
          
          alertasActuales = await response.json();
          actualizarTabla(alertasActuales);
          actualizarMetricas(alertasActuales);
        } catch (error) {
          console.error('Error cargando alertas:', error);
          mostrarError('No se pudieron cargar las alertas');
        }
      }

      // Funci√≥n para actualizar la tabla
      function actualizarTabla(alertas) {
        const tbody = document.getElementById('tablaAlertas');
        tbody.innerHTML = '';

        alertas.forEach(alerta => {
          const row = document.createElement('tr');
          
          // Determinar clase para falsa alarma
          const esFalsa = alerta.esFalsaAlarma ? ' (Falsa)' : '';
          
          row.innerHTML = `
            <td>${alerta.idAlerta}</td>
            <td>${new Date(alerta.fechaAlerta).toLocaleString()}</td>
            <td>${alerta.tipoAlerta}</td>
            <td>
              <span class="badge criticidad-${alerta.nivelCriticidad ? alerta.nivelCriticidad.toLowerCase() : 'media'}">
                ${alerta.nivelCriticidad || 'MEDIA'}
              </span>
            </td>
            <td>
              <span class="badge estado-${alerta.estadoAlerta ? alerta.estadoAlerta.toLowerCase() : 'pendiente'}">
                ${alerta.estadoAlerta || 'PENDIENTE'}${esFalsa}
              </span>
            </td>
            <td>${alerta.usuarioResponsable ? alerta.usuarioResponsable.nombre : 'Sin asignar'}</td>
            <td>
              <div class="acciones-container">
                ${generarBotonesAlerta(alerta)}
              </div>
            </td>
          `;
          
          tbody.appendChild(row);
        });
      }

      // Funci√≥n para generar botones seg√∫n rol y estado
      function generarBotonesAlerta(alerta) {
        let botones = '';
        const estado = alerta.estadoAlerta;
        const esAdmin = window.esAdministrador ? window.esAdministrador() : false;
        const esOperador = window.esOperador ? window.esOperador() : false;
        
        // Bot√≥n Ver (siempre visible)
        botones += `<button class="btn btn-primary" onclick="verDetalleAlerta(${alerta.idAlerta})">üëÅÔ∏è Ver</button>`;
        
        // Bot√≥n Asignarme (solo para alertas pendientes)
        if (estado === 'PENDIENTE') {
          botones += `<button class="btn btn-warning" onclick="asignarmeAlerta(${alerta.idAlerta})">üë§ Asignarme</button>`;
        }
        
        // Bot√≥n Resolver (para alertas en proceso o pendientes)
        if (estado === 'EN_PROCESO' || estado === 'PENDIENTE') {
          botones += `<button class="btn btn-success" onclick="abrirModalResolver(${alerta.idAlerta})">‚úÖ Resolver</button>`;
        }
        
        // Bot√≥n Historial (siempre disponible)
        botones += `<button class="btn btn-historial" onclick="verHistorial(${alerta.idAlerta})">üìã Historial</button>`;
        
        // Bot√≥n Falsa Alarma (solo si no est√° resuelta ni descartada)
        if (estado !== 'RESUELTA' && estado !== 'DESCARTADA') {
          botones += `<button class="btn btn-falsa" onclick="abrirModalFalsaAlarma(${alerta.idAlerta})">üö´ Falsa</button>`;
        }
        
        // Botones solo para ADMINISTRADOR
        if (esAdmin) {
          // Bot√≥n Escalar (solo si no es cr√≠tica)
          if (alerta.nivelCriticidad !== 'CRITICA') {
            botones += `<button class="btn btn-escalar" onclick="abrirModalEscalar(${alerta.idAlerta})">‚ö° Escalar</button>`;
          }
          
          // Bot√≥n Reasignar
          botones += `<button class="btn btn-reasignar" onclick="abrirModalReasignar(${alerta.idAlerta})">üîÑ Reasignar</button>`;
          
          // Bot√≥n Exportar
          botones += `<button class="btn btn-exportar" onclick="exportarAlerta(${alerta.idAlerta})">üìÑ Exportar</button>`;
        }
        
        // Bot√≥n Escalar a Admin para OPERADORES (solo alertas en proceso)
        if (esOperador && estado === 'EN_PROCESO') {
          botones += `<button class="btn btn-escalar-operador" onclick="abrirModalEscalarAdmin(${alerta.idAlerta})">üÜò Escalar</button>`;
        }
        
        return botones;
      }

      // Funci√≥n para actualizar m√©tricas
      function actualizarMetricas(alertas) {
        document.getElementById('totalAlertas').textContent = alertas.length;
        document.getElementById('alertasCriticas').textContent = 
          alertas.filter(a => a.nivelCriticidad === 'CRITICA').length;
        document.getElementById('alertasPendientes').textContent = 
          alertas.filter(a => a.estadoAlerta === 'PENDIENTE').length;
        document.getElementById('alertasResueltas').textContent = 
          alertas.filter(a => a.estadoAlerta === 'RESUELTA').length;
      }

      // Funciones de filtrado
      async function filtrarAlertas() {
        const estado = document.getElementById('filtroEstado').value;
        const nivelCriticidad = document.getElementById('filtroCriticidad').value;
        
        const filtros = {
          estado: estado,
          nivelCriticidad: nivelCriticidad
        };

        try {
          const response = await fetch('/api/alertas/filtrar', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(filtros)
          });
          
          if (response.ok) {
            const alertasFiltradas = await response.json();
            actualizarTabla(alertasFiltradas);
            actualizarMetricas(alertasFiltradas);
          }
        } catch (error) {
          console.error('Error filtrando alertas:', error);
          mostrarError('Error al filtrar alertas');
        }
      }

      function limpiarFiltros() {
        document.getElementById('filtroEstado').value = '';
        document.getElementById('filtroCriticidad').value = '';
        cargarAlertas();
      }

      // Funciones para los nuevos botones

      // 1. Ver Historial
      async function verHistorial(idAlerta) {
        try {
          const response = await fetch(`/api/alertas/${idAlerta}/historial`);
          if (response.ok) {
            const historial = await response.text();
            document.getElementById('historialAlertaId').textContent = idAlerta;
            document.getElementById('contenidoHistorial').textContent = 
              historial || 'No hay historial disponible para esta alerta.';
            abrirModalCentrado('modalHistorial');
          }
        } catch (error) {
          console.error('Error cargando historial:', error);
          mostrarError('Error al cargar el historial');
        }
      }

      // 2. Marcar como Falsa Alarma
      function abrirModalFalsaAlarma(idAlerta) {
        document.getElementById('alertaFalsaId').value = idAlerta;
        abrirModalCentrado('modalFalsaAlarma');
      }

      async function confirmarFalsaAlarma() {
        const idAlerta = document.getElementById('alertaFalsaId').value;
        const motivo = document.getElementById('motivoFalsa').value;
        
        if (!motivo.trim()) {
          mostrarError('Por favor indique el motivo');
          return;
        }
        
        try {
          const response = await fetch(`/api/alertas/${idAlerta}/marcar-falsa`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ motivo: motivo })
          });
          
          if (response.ok) {
            mostrarExito('Alerta marcada como falsa alarma');
            cerrarModalCentrado('modalFalsaAlarma');
            cargarAlertas();
          } else if (response.status === 403) {
            mostrarError('No tiene permisos para esta acci√≥n');
          }
        } catch (error) {
          console.error('Error marcando falsa alarma:', error);
          mostrarError('Error al marcar como falsa alarma');
        }
      }

      // 3. Resolver con Observaci√≥n
      function abrirModalResolver(idAlerta) {
        document.getElementById('alertaResolverId').value = idAlerta;
        document.getElementById('accionesTomadas').value = '';
        document.getElementById('observacionesResolucion').value = '';
        abrirModalCentrado('modalResolver');
      }

      async function confirmarResolucion() {
        const idAlerta = document.getElementById('alertaResolverId').value;
        const acciones = document.getElementById('accionesTomadas').value;
        const observaciones = document.getElementById('observacionesResolucion').value;
        
        if (!acciones.trim() || !observaciones.trim()) {
          mostrarError('Por favor complete todos los campos');
          return;
        }
        
        try {
          const response = await fetch(`/api/alertas/${idAlerta}/resolver-con-observacion`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              accionesTomadas: acciones,
              observaciones: observaciones
            })
          });
          
          if (response.ok) {
            mostrarExito('Alerta resuelta correctamente');
            cerrarModalCentrado('modalResolver');
            cargarAlertas();
          } else if (response.status === 400) {
            mostrarError('Las observaciones son obligatorias');
          }
        } catch (error) {
          console.error('Error resolviendo alerta:', error);
          mostrarError('Error al resolver la alerta');
        }
      }

      // 4. Escalar Alerta (solo admin)
      function abrirModalEscalar(idAlerta) {
        if (!window.esAdministrador || !window.esAdministrador()) {
          mostrarError('Solo los administradores pueden escalar alertas');
          return;
        }
        document.getElementById('alertaEscalarId').value = idAlerta;
        document.getElementById('motivoEscalar').value = '';
        abrirModalCentrado('modalEscalar');
      }

      async function confirmarEscalacion() {
        const idAlerta = document.getElementById('alertaEscalarId').value;
        const motivo = document.getElementById('motivoEscalar').value;
        
        if (!motivo.trim()) {
          mostrarError('Por favor indique el motivo');
          return;
        }
        
        try {
          const response = await fetch(`/api/alertas/${idAlerta}/escalar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ motivo: motivo })
          });
          
          if (response.ok) {
            mostrarExito('Alerta escalada a cr√≠tica');
            cerrarModalCentrado('modalEscalar');
            cargarAlertas();
          } else if (response.status === 403) {
            mostrarError('No tiene permisos para escalar alertas');
          }
        } catch (error) {
          console.error('Error escalando alerta:', error);
          mostrarError('Error al escalar la alerta');
        }
      }

      // 5. Reasignar Alerta (solo admin)
      async function abrirModalReasignar(idAlerta) {
        if (!window.esAdministrador || !window.esAdministrador()) {
          mostrarError('Solo los administradores pueden reasignar alertas');
          return;
        }
        
        document.getElementById('alertaReasignarId').value = idAlerta;
        
        try {
          const response = await fetch('/api/alertas/usuarios-activos');
          if (response.ok) {
            const usuarios = await response.json();
            const select = document.getElementById('nuevoResponsable');
            select.innerHTML = '<option value="">Seleccionar usuario...</option>';
            
            usuarios.forEach(usuario => {
              const option = document.createElement('option');
              option.value = usuario.idUsuario;
              option.textContent = `${usuario.nombre} (${usuario.rol})`;
              select.appendChild(option);
            });
          }
        } catch (error) {
          console.error('Error cargando usuarios:', error);
        }
        
        abrirModalCentrado('modalReasignar');
      }

      async function confirmarReasignacion() {
        const idAlerta = document.getElementById('alertaReasignarId').value;
        const idNuevoResponsable = document.getElementById('nuevoResponsable').value;
        const motivo = document.getElementById('motivoReasignar').value;
        
        if (!idNuevoResponsable || !motivo.trim()) {
          mostrarError('Por favor complete todos los campos');
          return;
        }
        
        try {
          const response = await fetch(`/api/alertas/${idAlerta}/reasignar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              idNuevoResponsable: parseInt(idNuevoResponsable),
              motivo: motivo
            })
          });
          
          if (response.ok) {
            mostrarExito('Alerta reasignada correctamente');
            cerrarModalCentrado('modalReasignar');
            cargarAlertas();
          } else if (response.status === 403) {
            mostrarError('No tiene permisos para reasignar alertas');
          }
        } catch (error) {
          console.error('Error reasignando alerta:', error);
          mostrarError('Error al reasignar la alerta');
        }
      }

      // 6. Exportar Alerta (solo admin)
      async function exportarAlerta(idAlerta) {
        if (!window.esAdministrador || !window.esAdministrador()) {
          mostrarError('Solo los administradores pueden exportar alertas');
          return;
        }
        
        try {
          const response = await fetch(`/api/alertas/${idAlerta}/exportar`);
          if (response.ok) {
            const reporte = await response.text();
            
            // Abrir en nueva ventana
            const ventana = window.open('', '_blank');
            ventana.document.write(reporte);
            ventana.document.close();
            
            // Opci√≥n para imprimir
            setTimeout(() => {
              if (confirm('¬øDesea imprimir el reporte?')) {
                ventana.print();
              }
            }, 500);
          } else if (response.status === 403) {
            mostrarError('No tiene permisos para exportar alertas');
          }
        } catch (error) {
          console.error('Error exportando alerta:', error);
          mostrarError('Error al exportar la alerta');
        }
      }

      // 7. Escalar a Admin (para operadores)
      function abrirModalEscalarAdmin(idAlerta) {
        document.getElementById('alertaEscalarAdminId').value = idAlerta;
        document.getElementById('motivoEscalarAdmin').value = '';
        abrirModalCentrado('modalEscalarAdmin');
      }

      async function confirmarEscalacionAdmin() {
        const idAlerta = document.getElementById('alertaEscalarAdminId').value;
        const motivo = document.getElementById('motivoEscalarAdmin').value;
        
        if (!motivo.trim()) {
          mostrarError('Por favor indique el motivo');
          return;
        }
        
        try {
          const response = await fetch(`/api/alertas/${idAlerta}/escalar-a-admin`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ motivo: motivo })
          });
          
          if (response.ok) {
            mostrarExito('Alerta escalada al administrador');
            cerrarModalCentrado('modalEscalarAdmin');
            cargarAlertas();
          }
        } catch (error) {
          console.error('Error escalando a admin:', error);
          mostrarError('Error al escalar la alerta');
        }
      }

      

      function mostrarError(mensaje) {
        alert('‚ùå ' + mensaje);
      }

      function mostrarExito(mensaje) {
        alert('‚úÖ ' + mensaje);
      }

      // Cerrar modal al hacer clic fuera
      window.onclick = function(event) {
        const modals = document.getElementsByClassName('modal');
        for (let modal of modals) {
          if (event.target === modal) {
            modal.style.display = 'none';
          }
        }
      }

      // Funciones existentes (mantener compatibilidad)
      async function verDetalleAlerta(idAlerta) {
        try {
          const response = await fetch(`/api/alertas/${idAlerta}`);
          const alerta = await response.json();
          
          let detalle = `üö® DETALLE DE ALERTA #${alerta.idAlerta}

üìÖ Fecha: ${new Date(alerta.fechaAlerta).toLocaleString()}
üìã Tipo: ${alerta.tipoAlerta}
‚ö†Ô∏è  Nivel: ${alerta.nivelCriticidad}
üìä Estado: ${alerta.estadoAlerta}
üö´ Falsa Alarma: ${alerta.esFalsaAlarma ? 'S√≠' : 'No'}
üìù Descripci√≥n: ${alerta.descripcion}
üë§ Responsable: ${alerta.usuarioResponsable ? alerta.usuarioResponsable.nombre : 'Sin asignar'}
‚úÖ Acciones: ${alerta.accionesTomadas || 'No especificadas'}
üìã Observaciones: ${alerta.observacionesResolucion || 'No especificadas'}`;

          if (alerta.deteccion) {
            detalle += `

üîç INFORMACI√ìN DE DETECCI√ìN:
   - Persona: ${alerta.deteccion.persona ? alerta.deteccion.persona.nombre : 'Desconocido'}
   - Tipo: ${alerta.deteccion.tipoDeteccion}
   - C√°mara: ${alerta.deteccion.camara ? alerta.deteccion.camara.nombreCamara : 'No especificada'}
   - Resultado: ${alerta.deteccion.resultado || 'N/A'}`;
          }

          alert(detalle);
        } catch (error) {
          console.error('Error cargando detalle:', error);
          mostrarError('Error al cargar los detalles de la alerta');
        }
      }

      async function asignarmeAlerta(idAlerta) {
        try {
          const response = await fetch(`/api/alertas/${idAlerta}/asignar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          
          if (response.ok) {
            mostrarExito('Alerta asignada correctamente');
            cargarAlertas();
          }
        } catch (error) {
          console.error('Error asignando alerta:', error);
          mostrarError('Error al asignar la alerta');
        }
      }

      // Reemplazar funci√≥n resolver antigua por la nueva
      async function resolverAlerta(idAlerta) {
        abrirModalResolver(idAlerta);
      }
    </script>
    <div id="modalOverlay" class="modal-overlay" onclick="cerrarModalDesdeOverlay()"></div>
</body>
</html>