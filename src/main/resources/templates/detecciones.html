<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Detecciones</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      height: 100vh;
      background: #f4f6f8;
    }
    /* Sidebar */
    .sidebar {
      width: 220px;
      background-color: #2c3e50;
      color: white;
      display: flex;
      flex-direction: column;
      padding: 20px 0;
    }
    .sidebar h2 {
      text-align: center;
      margin-bottom: 30px;
    }
    .sidebar a {
      color: white;
      text-decoration: none;
      padding: 12px 20px;
      display: block;
      transition: background 0.3s;
    }
    .sidebar a:hover {
      background-color: #34495e;
    }
    /* Main content */
    .main-content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }
    h1 {
      color: #2c3e50;
      margin-bottom: 10px;
    }
    .filtros {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    .filtros input, .filtros select, .filtros button {
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .metricas {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    .card-metrica {
      background: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      flex: 1;
      text-align: center;
    }
    .card-metrica h3 {
      margin: 0;
      font-size: 18px;
      color: #2c3e50;
    }
    .card-metrica p {
      font-size: 24px;
      font-weight: bold;
      margin: 5px 0 0;
      color: #3498db;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #eee;
      text-align: center;
    }
    th {
      background-color: #3498db;
      color: white;
    }
    .acciones button {
      margin: 0 5px;
      padding: 6px 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    .ver-btn {
      background-color: #2ecc71;
      color: white;
    }
    .alerta-btn {
      background-color: #e74c3c;
      color: white;
    }
  </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
      <h2>SIVI</h2>
      <a href="/dashboard">Dashboard</a>
      <a href="/alertas">Alertas</a>
      <a href="/camaras">Cámaras</a>
      <a href="/personas">Personas</a>
      <a href="/detecciones">Detecciones</a>
      <a href="/configuracion">Configuración</a>
    </div>

    <!-- Contenido principal -->
    <div class="main-content">
      <h1>Panel de Detecciones</h1>

      <!-- Filtros -->
      <div class="filtros">
        <input type="text" placeholder="Buscar persona...">
        <input type="date">
        <input type="time">
        <select>
          <option>Cámara</option>
          <option>Entrada principal</option>
          <option>Pasillo 2</option>
        </select>
        <select>
          <option>Tipo</option>
          <option>Facial</option>
          <option>Marcha</option>
        </select>
        <button>Filtrar</button>
      </div>

      <!-- Métricas -->
      <div class="metricas">
        <div class="card-metrica">
          <h3>Total de detecciones</h3>
          <p id="totalDetecciones">0</p>
        </div>
        <div class="card-metrica">
          <h3>Cámaras activas</h3>
          <p id="camarasActivas">0</p>
        </div>
        <div class="card-metrica">
          <h3>Alertas</h3>
          <p id="alertasGeneradas">0</p>
        </div>
        <div class="card-metrica">
          <h3>No identificados</h3>
          <p id="noIdentificados">0</p>
        </div>
      </div>

      <!-- Tabla de detecciones -->
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Fecha</th>
            <th>Imagen</th>
            <th>Tipo</th>
            <th>Cámara</th>
            <th>Persona</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <!-- Se llenará dinámicamente -->
        </tbody>
      </table>
    </div>

    <!-- Script para cargar detecciones -->
    <script>
      // Función para generar alerta
      function generarAlerta(idDeteccion) {
        const alerta = {
          idDeteccion: idDeteccion,
          tipoAlerta: "GENERADA_DESDE_DETECCION",
          descripcion: "Alerta generada automáticamente desde detección " + idDeteccion,
          fechaAlerta: new Date().toISOString(),
          idUsuario: 1 // puedes ajustar según el usuario logueado
        };

        fetch("/api/alertas", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(alerta)
        })
        .then(res => res.json())
        .then(data => {
          alert("Alerta creada con ID: " + data.idAlerta);
          // actualizar métricas de alertas
          const alertasGeneradas = document.getElementById("alertasGeneradas");
          alertasGeneradas.textContent = parseInt(alertasGeneradas.textContent) + 1;
        })
        .catch(err => console.error("Error creando alerta:", err));
      }

      // Función para ver detalle
      function verDetalle(det) {
        alert("Detalle de detección:\nID: " + det.idDeteccion +
              "\nFecha: " + det.fechaHora +
              "\nTipo: " + det.tipoDeteccion +
              "\nResultado: " + (det.resultado || "N/A") +
              "\nObservaciones: " + (det.observaciones || "N/A"));
      }

      // Cargar detecciones
      fetch("/api/detecciones")
        .then(res => res.json())
        .then(data => {
          const tbody = document.querySelector("table tbody");
          tbody.innerHTML = "";

          // Métricas dinámicas
          document.getElementById("totalDetecciones").textContent = data.length;
          document.getElementById("noIdentificados").textContent = data.filter(d => !d.persona).length;

          data.forEach(det => {
            const row = `
              <tr>
                <td>${det.idDeteccion}</td>
                <td>${det.fechaHora}</td>
                <td><img src="${det.imagenUrl}" alt="img" width="40"></td>
                <td>${det.tipoDeteccion}</td>
                <td>${det.camara?.nombre || "-"}</td>
                <td>${det.persona?.nombre || "Desconocido"}</td>
                <td class="acciones">
                  <button class="ver-btn" onclick='verDetalle(${JSON.stringify(det)})'>Ver detalle</button>
                  <button class="alerta-btn" onclick="generarAlerta(${det.idDeteccion})">Generar alerta</button>
                </td>
              </tr>`;
            tbody.innerHTML += row;
          });
        })
        .catch(err => console.error("Error cargando detecciones:", err));
    </script>
</body>
</html>
