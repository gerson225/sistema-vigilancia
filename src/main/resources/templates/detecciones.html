<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Detecciones</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      height: 100vh;
      background: #f4f6f8;
    }
    /* Sidebar */
    .sidebar {
      width: 220px;
      background-color: #2c3e50;
      color: white;
      display: flex;
      flex-direction: column;
      padding: 20px 0;
    }
    .sidebar h2 {
      text-align: center;
      margin-bottom: 30px;
    }
    .sidebar a {
      color: white;
      text-decoration: none;
      padding: 12px 20px;
      display: block;
      transition: background 0.3s;
    }
    .sidebar a:hover {
      background-color: #34495e;
    }
    /* Main content */
    .main-content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }
    h1 {
      color: #2c3e50;
      margin-bottom: 10px;
    }
    .filtros {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    .filtros input, .filtros select, .filtros button {
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .metricas {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    .card-metrica {
      background: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      flex: 1;
      text-align: center;
    }
    .card-metrica h3 {
      margin: 0;
      font-size: 18px;
      color: #2c3e50;
    }
    .card-metrica p {
      font-size: 24px;
      font-weight: bold;
      margin: 5px 0 0;
      color: #3498db;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #eee;
      text-align: center;
    }
    th {
      background-color: #3498db;
      color: white;
    }
    .acciones button {
      margin: 0 5px;
      padding: 6px 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    .ver-btn {
      background-color: #2ecc71;
      color: white;
    }
    .alerta-btn {
      background-color: #e74c3c;
      color: white;
    }
  </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
      <h2>SIVI</h2>
      <a href="/dashboard">Dashboard</a>
      <a href="/alertas">Alertas</a>
      <a href="/camaras">C√°maras</a>
      <a href="/vistas/personas">Personas</a>
      <a href="/detecciones">Detecciones</a>
      <a href="/configuracion">Configuraci√≥n</a>
    </div>

    <!-- Contenido principal -->
    <div class="main-content">
      <h1>Panel de Detecciones</h1>

      <!-- Filtros -->
<div class="filtros">
    <input type="text" id="filtroPersona" placeholder="Buscar persona...">
    <input type="date" id="filtroFecha">
    <input type="time" id="filtroHora">
    <select id="filtroCamara">
        <option value="">Todas las c√°maras</option>
        <option value="7">Camara Plaza Norte</option>
        <option value="8">Camara San Juan</option>
        <option value="9">Camara Miraflores</option>
        <option value="10">Camara Callao</option>
        <option value="11">Camara Villa El Salvador</option>
        <option value="12">Camara Ate</option>
    </select>
    <select id="filtroTipo">
        <option value="">Todos los tipos</option>
        <option value="FACIAL">Facial</option>
        <option value="MARCHA">Marcha</option>
    </select>
    <button onclick="filtrarDetecciones()">Filtrar</button>
    <button onclick="limpiarFiltros()">Limpiar</button>
</div>

      <!-- M√©tricas -->
      <div class="metricas">
        <div class="card-metrica">
          <h3>Total de detecciones</h3>
          <p id="totalDetecciones">0</p>
        </div>
        <div class="card-metrica">
          <h3>C√°maras activas</h3>
          <p id="camarasActivas">0</p>
        </div>
        <div class="card-metrica">
          <h3>Alertas</h3>
          <p id="alertasGeneradas">0</p>
        </div>
        <div class="card-metrica">
          <h3>No identificados</h3>
          <p id="noIdentificados">0</p>
        </div>
      </div>

      <!-- Tabla de detecciones -->
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Fecha</th>
            <th>Imagen</th>
            <th>Tipo</th>
            <th>C√°mara</th>
            <th>Persona</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <!-- Se llenar√° din√°micamente -->
        </tbody>
      </table>
    </div>

    <!-- Script para cargar detecciones -->
    <script>
      // Funci√≥n para generar alerta
      // Funci√≥n para generar alerta
function generarAlerta(idDeteccion) {
    const alerta = {
        idDeteccion: idDeteccion,
        tipoAlerta: "GENERADA_DESDE_DETECCION",
        descripcion: "Alerta generada autom√°ticamente desde detecci√≥n " + idDeteccion,
        fechaAlerta: new Date().toISOString(),
        idUsuario: 1
    };

    fetch("/api/alertas", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(alerta)
    })
    .then(res => res.json())
    .then(data => {
        alert("Alerta creada con ID: " + data.idAlerta);
        const alertasGeneradas = document.getElementById("alertasGeneradas");
        alertasGeneradas.textContent = parseInt(alertasGeneradas.textContent) + 1;
    })
    .catch(err => console.error("Error creando alerta:", err));
}

// Funci√≥n para ver detalle
function verDetalle(det) {
    alert("Detalle de detecci√≥n:\nID: " + det.idDeteccion +
          "\nFecha: " + det.fechaHora +
          "\nTipo: " + det.tipoDeteccion +
          "\nResultado: " + (det.resultado || "N/A") +
          "\nObservaciones: " + (det.observaciones || "N/A"));
}

// Funciones para filtrado
async function filtrarDetecciones() {
    const filtros = {
        persona: document.getElementById('filtroPersona').value,
        fecha: document.getElementById('filtroFecha').value,
        hora: document.getElementById('filtroHora').value,
        camara: document.getElementById('filtroCamara').value,
        tipo: document.getElementById('filtroTipo').value
    };

    try {
        const response = await fetch('/api/detecciones/filtrar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(filtros)
        });
        
        // Si el endpoint no existe, cargar todas las detecciones
        if (!response.ok) {
            console.log('Endpoint de filtrado no disponible, cargando todas las detecciones');
            cargarDetecciones();
            return;
        }
        
        const data = await response.json();
        console.log('Datos recibidos del filtrado:', data);
        actualizarTabla(data);
    } catch (error) {
        console.error('Error filtrando detecciones:', error);
        // Si hay error, cargar todas las detecciones
        cargarDetecciones();
    }
}

function limpiarFiltros() {
    document.getElementById('filtroPersona').value = '';
    document.getElementById('filtroFecha').value = '';
    document.getElementById('filtroHora').value = '';
    document.getElementById('filtroCamara').value = '';
    document.getElementById('filtroTipo').value = '';
    
    cargarDetecciones();
}

function actualizarTabla(detecciones) {
    console.log('üîÑ Actualizando tabla con:', detecciones);
    
    const tbody = document.querySelector("table tbody");
    tbody.innerHTML = "";

    console.log('üìä Total detecciones a mostrar:', detecciones.length);

    // M√©tricas din√°micas
    document.getElementById("totalDetecciones").textContent = detecciones.length;
    document.getElementById("noIdentificados").textContent = detecciones.filter(d => !d.persona).length;

    detecciones.forEach((det, index) => {
        console.log(`  üìù Procesando detecci√≥n ${index + 1}:`, det);
        
        const row = `
            <tr>
                <td>${det.idDeteccion}</td>
                <td>${det.fechaHora}</td>
                <td><img src="${det.imagenUrl || '/images/persona1.png'}" alt="img" width="40" onerror="this.src='/images/persona1.png'"></td>
                <td>${det.tipoDeteccion}</td>
                <td>${det.camara?.nombreCamara || "-"}</td>
                <td>${det.persona?.nombre || "Desconocido"}</td>
                <td class="acciones">
                    <button class="ver-btn" onclick='verDetalle(${JSON.stringify(det).replace(/'/g, "&#39;")})'>Ver detalle</button>
                    <button class="alerta-btn" onclick="generarAlerta(${det.idDeteccion})">Generar alerta</button>
                </td>
            </tr>`;
        tbody.innerHTML += row;
    });
    
    console.log('‚úÖ Tabla actualizada. Filas en tbody:', tbody.children.length);
}

// Funci√≥n para cargar todas las detecciones (sin filtros)
async function cargarDetecciones() {
    try {
        console.log('üîç Iniciando carga de detecciones...');
        const response = await fetch("/api/detecciones");
        console.log('üì° Response status:', response.status);
        console.log('üì° Response ok:', response.ok);
        
        if (response.ok) {
            const data = await response.json();
            console.log('‚úÖ Datos crudos de API:', data);
            console.log('üìä N√∫mero de detecciones recibidas:', data.length);
            console.log('üîç Detalle de cada detecci√≥n:');
            data.forEach((det, index) => {
                console.log(`  ${index + 1}. ID: ${det.idDeteccion}, Persona: ${det.persona?.nombre || 'N/A'}, C√°mara: ${det.camara?.nombreCamara || 'N/A'}`);
            });
            actualizarTabla(data);
        } else {
            console.error('‚ùå Error en response:', response.status, response.statusText);
            // Usar datos de prueba
            cargarDeteccionesPrueba();
        }
    } catch (error) {
        console.error("üö® Error cargando detecciones:", error);
        cargarDeteccionesPrueba();
    }
}
function cargarDeteccionesPrueba() {
    console.log('üîÑ Cargando datos de prueba...');
    const datosPrueba = [
        {
            idDeteccion: 4,
            fechaHora: "2024-11-18T10:15:00",
            imagenUrl: "/images/persona1.png",
            tipoDeteccion: "FACIAL",
            resultado: "Luis Perez",
            observaciones: "Reconocido con alta confianza",
            persona: { nombre: "Luis Perez" },
            camara: { nombreCamara: "Camara Plaza Norte" }
        },
        {
            idDeteccion: 5, 
            fechaHora: "2024-11-18T10:20:00",
            imagenUrl: "/images/persona2.png",
            tipoDeteccion: "MARCHA",
            resultado: "Carlos Ramirez", 
            observaciones: "Movimiento sospechoso en pasillo",
            persona: { nombre: "Carlos Ramirez" },
            camara: { nombreCamara: "Camara Miraflores" }
        },
        {
            idDeteccion: 6,
            fechaHora: "2024-11-18T11:00:00", 
            imagenUrl: "/images/persona3.png",
            tipoDeteccion: "FACIAL",
            resultado: "Desconocido",
            observaciones: "No se pudo identificar",
            persona: null,
            camara: { nombreCamara: "Camara Ate" }
        }
    ];
    console.log('‚úÖ Datos de prueba cargados:', datosPrueba);
    actualizarTabla(datosPrueba);
}

// Cargar detecciones cuando la p√°gina se carga
document.addEventListener('DOMContentLoaded', function() {
    cargarDetecciones();
});
    </script>
</body>
</html>
