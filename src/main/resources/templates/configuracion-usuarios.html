<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gesti√≥n de Usuarios - Configuraci√≥n</title>
    <link rel="stylesheet" href="/css/layout.css">
    <style>
        .config-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .help-text {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .badge-admin { background: #e74c3c; color: white; padding: 4px 8px; border-radius: 12px; }
        .badge-operador { background: #3498db; color: white; padding: 4px 8px; border-radius: 12px; }
        
        .table-responsive {
            overflow-x: auto;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin: 2px;
        }
        
        .btn-success { background: #27ae60; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-info { background: #3498db; color: white; }
    </style>
    <script src="/js/session-manager.js"></script>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        
    </div>

    <!-- Contenido principal -->
    <div class="main-content">
        <h1>üë• Gesti√≥n de Usuarios del Sistema</h1>
        
        <!-- Formulario de registro -->
        <div class="config-section">
            <h2>‚ûï Registrar Nuevo Usuario</h2>
            <form id="formUsuario">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="nombre">Nombre completo *</label>
                        <input type="text" id="nombre" required>
                    </div>
                    <div class="form-group">
                        <label for="rol">Rol *</label>
                        <select id="rol" required onchange="actualizarPatronUsuario()">
                            <option value="">Seleccionar rol</option>
                            <option value="ADMINISTRADOR">Administrador</option>
                            <option value="OPERADOR">Operador</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="usuario">Nombre de usuario *</label>
                        <input type="text" id="usuario" required>
                        <div class="help-text" id="helpUsuario">
                            Seleccione un rol para ver el patr√≥n requerido
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="contrasena">Contrase√±a temporal *</label>
                        <input type="password" id="contrasena" required value="Temp123456">
                        <div class="help-text">El usuario deber√° cambiar su contrase√±a en el primer login</div>
                    </div>
                </div>
                <button type="button" class="btn btn-success" onclick="guardarUsuario()">üíæ Guardar Usuario</button>
            </form>
        </div>

        <!-- Lista de usuarios -->
        <div class="config-section">
            <h2>üìã Usuarios Registrados</h2>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Usuario</th>
                            <th>Rol</th>
                            <th>Fecha Creaci√≥n</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaUsuarios">
                        <!-- Se llenar√° din√°micamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal para cambiar contrase√±a -->
    <div class="modal-overlay" id="passwordOverlay" onclick="cerrarModalPassword()"></div>
    <div class="modal" id="passwordModal">
        <h3>üîê Cambiar Contrase√±a</h3>
        <div class="form-group">
            <label for="nuevaContrasena">Nueva contrase√±a *</label>
            <input type="password" id="nuevaContrasena" required>
            <div class="help-text">M√≠nimo 6 caracteres</div>
        </div>
        <div class="form-group">
            <label for="confirmarContrasena">Confirmar contrase√±a *</label>
            <input type="password" id="confirmarContrasena" required>
        </div>
        <div style="margin-top: 20px; display: flex; gap: 10px;">
            <button class="btn btn-success" onclick="cambiarContrasena()">üíæ Cambiar</button>
            <button class="btn btn-danger" onclick="cerrarModalPassword()">‚ùå Cancelar</button>
        </div>
    </div>

    <script>
        let usuarioEditando = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            cargarUsuarios();
        });

        function actualizarPatronUsuario() {
            const rol = document.getElementById('rol').value;
            const helpText = document.getElementById('helpUsuario');
            
            if (rol === 'ADMINISTRADOR') {
                helpText.innerHTML = 'Patr√≥n requerido: <strong>A12345678</strong> (A + 8 d√≠gitos)';
                document.getElementById('usuario').placeholder = 'A12345678';
            } else if (rol === 'OPERADOR') {
                helpText.innerHTML = 'Patr√≥n requerido: <strong>O87654321</strong> (O + 8 d√≠gitos)';
                document.getElementById('usuario').placeholder = 'O87654321';
            } else {
                helpText.innerHTML = 'Seleccione un rol para ver el patr√≥n requerido';
                document.getElementById('usuario').placeholder = '';
            }
        }

        async function cargarUsuarios() {
            try {
                const response = await fetch('/api/usuarios');
                if (response.ok) {
                    const usuarios = await response.json();
                    actualizarTablaUsuarios(usuarios);
                }
            } catch (error) {
                console.error('Error cargando usuarios:', error);
            }
        }

        function actualizarTablaUsuarios(usuarios) {
            const tbody = document.getElementById('tablaUsuarios');
            tbody.innerHTML = '';

            usuarios.forEach(usuario => {
                const fecha = new Date(usuario.fechaCreacion).toLocaleDateString();
                const row = `
                    <tr>
                        <td>${usuario.idUsuario}</td>
                        <td>${usuario.nombre}</td>
                        <td><strong>${usuario.usuario}</strong></td>
                        <td>
                            <span class="badge-${usuario.rol.toLowerCase()}">
                                ${usuario.rol}
                            </span>
                        </td>
                        <td>${fecha}</td>
                        <td>
                            <button class="btn btn-warning" onclick="editarUsuario(${usuario.idUsuario})">‚úèÔ∏è Editar</button>
                            <button class="btn btn-info" onclick="abrirModalPassword(${usuario.idUsuario})">üîê Contrase√±a</button>
                            <button class="btn btn-danger" onclick="eliminarUsuario(${usuario.idUsuario})">üóëÔ∏è Eliminar</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        async function guardarUsuario() {
            const usuarioData = {
                nombre: document.getElementById('nombre').value,
                usuario: document.getElementById('usuario').value,
                rol: document.getElementById('rol').value,
                contrasena: document.getElementById('contrasena').value
            };

            try {
                const response = await fetch('/api/usuarios', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(usuarioData)
                });

                if (response.ok) {
                    alert('‚úÖ Usuario registrado correctamente');
                    document.getElementById('formUsuario').reset();
                    cargarUsuarios();
                } else {
                    const error = await response.text();
                    alert('‚ùå Error: ' + error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error al registrar el usuario');
            }
        }

        async function eliminarUsuario(id) {
            if (confirm('¬øEst√°s seguro de eliminar este usuario?')) {
                try {
                    const response = await fetch(`/api/usuarios/${id}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        alert('‚úÖ Usuario eliminado correctamente');
                        cargarUsuarios();
                    } else {
                        alert('‚ùå Error al eliminar el usuario');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('‚ùå Error al eliminar el usuario');
                }
            }
        }

        function abrirModalPassword(idUsuario) {
            usuarioEditando = idUsuario;
            document.getElementById('passwordOverlay').style.display = 'block';
            document.getElementById('passwordModal').style.display = 'block';
        }

        function cerrarModalPassword() {
            document.getElementById('passwordOverlay').style.display = 'none';
            document.getElementById('passwordModal').style.display = 'none';
            usuarioEditando = null;
        }

        async function cambiarContrasena() {
            const nuevaContrasena = document.getElementById('nuevaContrasena').value;
            const confirmarContrasena = document.getElementById('confirmarContrasena').value;

            if (nuevaContrasena !== confirmarContrasena) {
                alert('‚ùå Las contrase√±as no coinciden');
                return;
            }

            if (nuevaContrasena.length < 6) {
                alert('‚ùå La contrase√±a debe tener al menos 6 caracteres');
                return;
            }

            try {
                const response = await fetch(`/api/usuarios/${usuarioEditando}/cambiar-contrasena`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ nuevaContrasena })
                });

                if (response.ok) {
                    alert('‚úÖ Contrase√±a cambiada correctamente');
                    cerrarModalPassword();
                } else {
                    const error = await response.text();
                    alert('‚ùå Error: ' + error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error al cambiar contrase√±a');
            }
        }

        // Funci√≥n editarUsuario (similar a la de c√°maras)
        async function editarUsuario(id) {
            // Implementar similar al m√≥dulo de c√°maras
            alert(`‚úèÔ∏è Editar usuario ${id} - Por implementar`);
        }
    </script>
</body>
</html>